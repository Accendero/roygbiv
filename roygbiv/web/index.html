<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - loaders - vtk loader</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" type="text/css" href="css/style.css" />

		<script src="js/libs/three.min.js"></script>
		<script src="js/libs/Projector.js"></script>
		<script src="js/libs/Detector.js"></script>
		<script src="js/libs/TrackballControls.js"></script>
		<script src="js/libs/VTKLoader.js"></script>
		<!--<script src="js/libs/Detector.js"></script>
		<script src="js/libs/stats.min.js"></script>-->
		<script src="js/libs/jquery.min.js"></script>
		<script src="js/libs/d3.min.js"></script>
        <script src="js/libs/box.js"></script>
        <script src="js/libs/sprintf.js"></script>
		<script src="js/libs/angular.min.js"></script>

        <script src="js/brain.utils.js"></script>
        <script src="js/brain.js"></script>
		<script src="js/boxplot.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>

        <!--Some stuff for color scale-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://d3js.org/d3.v4.js"></script>
		
	</head>

	<body>
		<div ng-app="navigator" ng-controller="NavigateController" ng-strict-di>
			<div id="header_n_label">
				<h1>ROYGBIV</h1>
				<div id="nav_label">
					Shift+click on a label to see stats
					<br />
					<br />
					Selected Label: {{selectedLabel}}
				</div>
				<div id="plot-canvas" style="width: 400px; height: 300px;">
				</div>
			</div>
			<div id="nav-brain" style="width: 60%; height: 900px; margin-top: 50px; margin-right: 50px;">
			</div>
		</div>

		<script>
			angular.module('navigator', [])
			.controller('NavigateController', ['$scope', function($scope) {
			    d3.csv("./data/keys.csv", function(keystuff) {
                    d3.csv("./data/Allen_clean.csv", function (datas) {
                        /*
						//Intent of the below chunk is to clean data to allow for input into application
						//"headerNames" and "name" are used to make header names the key for the object "name"

						var headerNames = d3.keys(datas[0]);
						var name = {
								"1002": "ctx-lh-caudalanteriorcingulate",
								"1003": "ctx-lh-caudalmiddlefrontal",
								"1005": "ctx-lh-cuneus",
								"1006": "ctx-lh-entorhinal",
								"1007": "ctx-lh-fusiform",
								"1008": "ctx-lh-inferiorparietal",
								"1009": "ctx-lh-inferiortemporal",
								"1010": "ctx-lh-isthmuscingulate",
								"1011": "ctx-lh-lateraloccipital",
								"1012": "ctx-lh-lateralorbitofrontal",
								"1013": "ctx-lh-lingual",
								"1014": "ctx-lh-medialorbitofrontal",
								"1015": "ctx-lh-middletemporal",
								"1016": "ctx-lh-parahippocampal",
								"1017": "ctx-lh-paracentral",
								"1018": "ctx-lh-parsopercularis",
								"1019": "ctx-lh-parsorbitalis",
								"1020": "ctx-lh-parstriangularis",
								"1021": "ctx-lh-pericalcarine",
								"1022": "ctx-lh-postcentral",
								"1023": "ctx-lh-posteriorcingulate",
								"1024": "ctx-lh-precentral",
								"1025": "ctx-lh-precuneus",
								"1026": "ctx-lh-rostralanteriorcingulate",
								"1027": "ctx-lh-rostralmiddlefrontal",
								"1028": "ctx-lh-superiorfrontal",
								"1029": "ctx-lh-superiorparietal",
								"1030": "ctx-lh-superiortemporal",
								"1031": "ctx-lh-supramarginal",
								"1034": "ctx-lh-transversetemporal",
								"1035": "ctx-lh-insula",
								"2002": "ctx-rh-caudalanteriorcingulate",
								"2003": "ctx-rh-caudalmiddlefrontal",
								"2005": "ctx-rh-cuneus",
								"2006": "ctx-rh-entorhinal",
								"2007": "ctx-rh-fusiform",
								"2008": "ctx-rh-inferiorparietal",
								"2009": "ctx-rh-inferiortemporal",
								"2010": "ctx-rh-isthmuscingulate",
								"2011": "ctx-rh-lateraloccipital",
								"2012": "ctx-rh-lateralorbitofrontal",
								"2013": "ctx-rh-lingual",
								"2014": "ctx-rh-medialorbitofrontal",
								"2015": "ctx-rh-middletemporal",
								"2016": "ctx-rh-parahippocampal",
								"2017": "ctx-rh-paracentral",
								"2018": "ctx-rh-parsopercularis",
								"2019": "ctx-rh-parsorbitalis",
								"2020": "ctx-rh-parstriangularis",
								"2021": "ctx-rh-pericalcarine",
								"2022": "ctx-rh-postcentral",
								"2023": "ctx-rh-posteriorcingulate",
								"2024": "ctx-rh-precentral",
								"2025": "ctx-rh-precuneus",
								"2026": "ctx-rh-rostralanteriorcingulate",
								"2027": "ctx-rh-rostralmiddlefrontal",
								"2028": "ctx-rh-superiorfrontal",
								"2029": "ctx-rh-superiorparietal",
								"2030": "ctx-rh-superiortemporal",
								"2031": "ctx-rh-supramarginal",
								"2034": "ctx-rh-transversetemporal",
								"2035": "ctx-rh-insula"
						};

						//Iterate through name and rearrange csv columns by value to map to key
						var names_values = Object.values(name);
						var names_keys = Object.keys(name);

						for (var stuff = 0; stuff < 70; stuff ++) {
							for (var items = 0; items < 62; items++) {
								if (headerNames[stuff] === names_values[items]) {
									headerNames[stuff] = names_keys[items];
								}
							}
						}
						//Data headers converted to keys
						//TO DO:
						//Remove unnecessary columns
						//Build object with key = row number(index) and value = gene
						*/
						//Build index/gene pair object
                        var keyObj = keystuff[0];

						//Currently, values in 'keyObj' and indexes in 'datas' are identical
                        var gene = 'DARC';
                        var loc = keyObj[gene];
                        var data = datas[loc];
                        //console.log(data);

                        //function to calculate mean
                        function mean(data) {
                            var total = 0;
                            for (var i = 0; i < data.length; i += 1) {
                                total += data[i];
                            }
                            return total / data.length;
                        }

                        //Need to pull values to calculate mid, min, max
                        var values = Object.values(data);
                        values = values.map(Number);

                        var mid = mean(values),
                            min = Math.min(...values);
						var big = Math.max(...values);

                        //return scale of colors for min to mid to max values
                        var colors = d3.scale.linear()
                            .domain([min, mid, big])
                            .range(['#ffffff', '#ffd400', '#ff0000']);

                        //take color scale and return values mapped to object
                        //range will be replaced with list of values, key should be
                        //taken from column headers

                        //ISSUE Each val of j represented in values
                        //Each val of j + 1002 not represented in data
                        //Color scale works, but unfortunately since expressions are all so similar, colors are almost identical
                        var dict = [];
                        for (var j = 1002; j < 1036; j++) {
                            if (data[j]) {
                                dict[j] = [
                                    d3.color(colors(parseFloat(data[j]))).r / 256,
                                    d3.color(colors(parseFloat(data[j]))).g / 256,
                                    d3.color(colors(parseFloat(data[j]))).b / 256
                                ];
                            }
                        }
                        //$scope.brain.setColors(dict);
                        $scope.brain = new Brain({
                            divID: "nav-brain",  // div to render brain
                            callback: function (mesh) {
                                // callback when a mesh is selected/deselected
                                if (!mesh) {
                                    // deselected: clear label & plot
                                    $scope.selectedLabel = "";
                                    $('#plot-canvas').empty();
                                } else {
                                    // selected: add label, do plot.
                                    $scope.selectedLabel = mesh.name;
                                    do_boxplot("plot-canvas", mesh);
                                }
                                $scope.$apply();
                            },
                            manifest_url: 'data/lh_files_to_load.json',
                            label_mapper: "data/labels.json",
                            colors: dict
                        });
                    });
                });
			}]);
		</script>
	</body>
</html>
